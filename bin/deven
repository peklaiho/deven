#!/usr/bin/env php
<?php
require(__DIR__ . '/../vendor/autoload.php');

// Debug mode: more verbose output
define('DEVEN_DEBUG', true);

// If no arguments, show help and exit
if ($argc < 2) {
    PekLaiho\Deven\Utils::outln('Available commands:');
    PekLaiho\Deven\Utils::outln('create');
    PekLaiho\Deven\Utils::outln('destroy');
    PekLaiho\Deven\Utils::outln('image');
    PekLaiho\Deven\Utils::outln('status');
    exit(0);
}

$homeDir = getenv('HOME');
if (!$homeDir) {
    PekLaiho\Deven\Utils::error('Unable to read user home directory from environment');
}

// Define directories as constants
define('DEVEN_DIR', $homeDir . DIRECTORY_SEPARATOR . '.deven');
define('DEVEN_IMAGE_DIR', DEVEN_DIR . DIRECTORY_SEPARATOR . 'images');
define('DEVEN_TMP_DIR', DEVEN_DIR . DIRECTORY_SEPARATOR . 'tmp');
define('DEVEN_VBOX_DIR', $homeDir . DIRECTORY_SEPARATOR . 'VirtualBox VMs');

// Create directories if needed
PekLaiho\Deven\Utils::createDir(DEVEN_DIR);
PekLaiho\Deven\Utils::createDir(DEVEN_IMAGE_DIR);
PekLaiho\Deven\Utils::createDir(DEVEN_TMP_DIR);

$configFinder = new PekLaiho\Deven\ConfigFinder();
$configFile = $configFinder->find();

if (!$configFile) {
    PekLaiho\Deven\Utils::error('Unable to find deven.yml file in current directory');
}

$configReader = new PekLaiho\Deven\ConfigReader();
$config = $configReader->read($configFile);

$hypervisor = new PekLaiho\Deven\VirtualBox();

$commandMap = [
    'create' => new PekLaiho\Deven\Cmd\Create(),
    'destroy' => new PekLaiho\Deven\Cmd\Destroy(),
    'image' => new PekLaiho\Deven\Cmd\Image(),
    'status' => new PekLaiho\Deven\Cmd\Status(),
];

$command = null;
foreach ($commandMap as $name => $cmd) {
    if (str_starts_with($name, $argv[1])) {
        $command = $cmd;
        break;
    }
}

if (!$command) {
    PekLaiho\Deven\Utils::error('Unknown command: ' . $argv[1]);
}

$command->execute($hypervisor, $config, array_slice($argv, 2));
